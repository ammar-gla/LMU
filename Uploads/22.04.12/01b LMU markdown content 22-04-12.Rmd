---
title:  "<br> London Labour Market Update"
date: "`r format(Sys.Date(),'%B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    css:  !expr "here::here('FORMATTING','GLAstyle.css')"
    includes:
      in_header: !expr "here::here('FORMATTING','favicon.html')"
      before_body: !expr "here::here('FORMATTING','header.html')"
      after_body: !expr "here::here('FORMATTING','footer.html')"
---

```{r setup, include=FALSE}
  
  knitr::opts_chunk$set(echo = TRUE,scipen=999)
  knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
  
  #################################################################
  ###  Load packages and set paths
  #################################################################

  library("here") # To set project folder dynamically
  
```

```{r, main_figures ,echo=FALSE}
  ### Create all the figures needed for the section below
  # Name format:
  # _d_: difference, _p_: difference in percent, _pp_: difference in percentage points, _uk: UK level stat, London otherwise
  
  # Paye
  paye_d_month <- value_form(paye_stats %>% filter( new_date == max(new_date)) %>% select(lon_month_change),s= signif_thous)
  
  paye_p_month <- perc_form(paye_stats %>% filter( new_date == max(new_date)) %>% select(lon_month_percentage_change),d = digits_perc)
  
  paye_newmonth <- paye_stats %>% filter( new_date == max(new_date)) %>% mutate(new_date=format(new_date,'%B %Y')) %>%  select(new_date)
  
  paye_lastmonth <- paye_stats  %>% mutate(lag_month = lag(new_date, n = 1)) %>% mutate(lag_month2 = format(lag_month, '%B')) %>% filter( new_date == max(new_date)) %>%  select(lag_month2)
  
  paye_p_feb20 <- perc_form(paye_stats %>% filter( new_date == max(new_date)) %>% select(lon_percentage_change_since_feb20),d = digits_perc)
  
  # LFS
  
  lfs_newmonth <- lfs_stats %>% mutate(month = format(date, '%B %Y')) %>% filter(sex_name == "Total"  & geography_name == "London" & value_type_name == "Level" & date == max(date) & measures == 20207) %>%  select(month)
  
  lfs_lastmonth <- lfs_stats  %>% mutate(lag_month = ymd(date) %m+% - months(2)) %>% mutate(lag_month2 = format(lag_month, '%B')) %>% filter(sex_name == "Total"  & geography_name == "London" & value_type_name == "Level" & date == max(date) & measures == 20207) %>%  select(lag_month2)
  
  
  # Unem
  
  unem_rate <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London" & value_type_name == "Level" & measures == 20207) %>% select(total_unemployed_aged_16_and_over),d = digits_perc)
  
  unem_pp_quart <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London" & value_type_name == "Change on quarter" & measures == 20207) %>% select(total_unemployed_aged_16_and_over),d = digits_perc)
  
  
  unem_pp_year <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London" & value_type_name == "Change on year" & measures == 20207)  %>% select(total_unemployed_aged_16_and_over),d = digits_perc)
  
  unem_rate_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Level" & measures == 20207) %>% select(total_unemployed_aged_16_and_over),d = digits_perc)
  
  
  # Employment
  
  emp_rate <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London" & value_type_name == "Level" & measures == 20207)  %>% select(total_in_employment_aged_16_to_64),d = digits_perc)
  
  emp_pp_quart <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London"  & value_type_name == "Change on quarter" & measures == 20207)  %>% select(total_in_employment_aged_16_to_64),d = digits_perc)
  
  emp_pp_year <-perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London"  & value_type_name == "Change on year" & measures == 20207) %>% select(total_in_employment_aged_16_to_64),d = digits_perc)
  
  emp_rate_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Level" & measures == 20207)  %>% select(total_in_employment_aged_16_to_64),d = digits_perc)
  
  # Inactivity
  
  inact_rate <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London" & value_type_name == "Level" & measures == 20207)  %>% select(total_economically_inactive_aged_16_to_64),d = digits_perc)
  
  inact_pp_quart <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London"  & value_type_name == "Change on quarter" & measures == 20207)  %>% select(total_economically_inactive_aged_16_to_64),d = digits_perc)
  
  inact_pp_year <-perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London"  & value_type_name == "Change on year" & measures == 20207) %>% select(total_economically_inactive_aged_16_to_64),d = digits_perc)
  
  inact_rate_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Level" & measures == 20207)  %>% select(total_economically_inactive_aged_16_to_64),d = digits_perc)
  
  # WFJ
  
  wfj_year <-  wfj_stats %>% filter(new_date == max(new_date)) %>% filter(row_number()==1) %>% mutate(year=year(new_date)) %>% select(year)
  
  wfj_newquarter <- wfj_stats %>% ungroup()  %>% filter(new_date == max(new_date)) %>% filter(row_number()==1) %>% select(quarter_text) 
  
  wfj_oldquarter <-  wfj_stats %>% filter(new_date == (ymd(max(new_date)) %m+% - months(3))) %>% filter(row_number()==1) %>% select(quarter_text)
  
  wfj_d_quart <- value_form(wfj_stats%>% ungroup()  %>% filter(item_name == "total workforce jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd(max(new_date)) %m+% - months(3)) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value),s = signif_thous)
  
  wfj_p_quart <- perc_form(100*(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd(max(new_date)) %m+% - months(3)) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value))/(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd(max(new_date)) %m+% - months(3)) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value)),d = digits_perc)
  
  wfj_d_dec19 <- value_form(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value),s = signif_thous)
  
  wfj_p_dec19 <- perc_form(100*(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value))/(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value)),d = digits_perc)

```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<!-- Summary of findings - MANUALLY ADJUST -->

<br/>

## Summary of key points

<br/>

-   The most timely estimate of **payrolled employees** shows  `r condi_text(paye_d_month,"noun")` of around `r abs2(paye_d_month)`, or `r abs2(paye_p_month)`%, in London between `r paye_lastmonth` and `r paye_newmonth` and is `r abs2(paye_p_feb20)`% `r condi_text(paye_p_feb20,"above")` pre-pandemic (February 2020) levels. 

-   The **employment rate** in London was estimated at `r emp_rate`% for the three months ending `r lfs_newmonth`, `r condi_text(emp_pp_quart,"up")` `r abs2(emp_pp_quart)` percentage points (pp) on the previous quarter and `r condi_text(emp_pp_year,"up")` `r abs2(emp_pp_year)`pp on the same period in the previous year. London's employment rate remains close to the UK average (`r emp_rate_uk`%).

-   The **unemployment rate** continued to fall from its pandemic peak but is still higher than the UK average. London's unemployment rate was estimated at `r unem_rate`%, `r condi_text(unem_pp_quart,"up")` `r abs2(unem_pp_quart)`pp on the quarter and `r condi_text(unem_pp_year,"up")` `r abs2(unem_pp_year)`pp from a year earlier. The UK average was `r unem_rate_uk`%.

-   London's **inactivity rate** (the measure of those not looking and/or not available to work) was estimated at `r inact_rate`%. This was `r condi_text(inact_pp_year,"up")` `r abs2(inact_pp_year)`pp on the previous year and  `r condi_text(inact_pp_quart,"up")` `r abs2(inact_pp_quart)`pp on the previous quarter but remains lower than the UK-wide estimate of `r inact_rate_uk`%.


<a href="#top">Back to top</a>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>


## Measuring the labour market

<br/>

The ONS has published its latest [labour market update](https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes) covering Labour Force Survey (LFS) data for the three months ending `r lfs_newmonth`. This bulletin presents the latest headline labour market estimates for London.

Please note:

-   Many of the statistics presented here are estimates based on surveys, and as such have a margin of error -- known as sampling variability.

-   They also cover different reference periods or count dates, and have therefore been impacted differently by the spread of COVID-19.

More information and previous GLA Economics analyses can be found on our labour market analysis [page](https://data.london.gov.uk/dataset/gla-economics-covid-19-labour-market-analysis).

More information on the data used and a glossary of terms can be found on the [ONS website](https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/methodologies/aguidetolabourmarketstatistics).

```{r,paye figures, echo=FALSE}

  paye_level <- value_form(paye_stats %>% filter( new_date == max(new_date)) %>% mutate(lon_round=london/1000000) %>% select(lon_round),s=signif_mil, d=digits_mil)
  
  paye_d_year <- value_form(paye_stats %>% filter( new_date == max(new_date))  %>% select(lon_annual_change),s=signif_thous)
    
  paye_p_year <- perc_form(paye_stats %>% filter( new_date == max(new_date)) %>% select(lon_annual_percentage_change),d = digits_perc)
  
  paye_lastyearmonth <- paye_stats  %>% mutate(lag_month = lag(new_date, n = 12)) %>% mutate(lag_month2 = format(lag_month, '%B %Y')) %>% filter( new_date == max(new_date)) %>%  select(lag_month2)
    
  paye_p_year_uk <- perc_form(paye_stats %>% filter( new_date == max(new_date)) %>% select(uk_annual_percentage_change),d = digits_perc)
  
  paye_d_feb20 <- value_form(paye_stats %>% filter( new_date == max(new_date))  %>% select(lon_change_since_feb20),s=signif_thous)
  
  paye_p_feb20 <- perc_form(paye_stats %>% filter( new_date == max(new_date)) %>% select(lon_percentage_change_since_feb20),d = digits_perc)
  
  paye_d_feb20_uk <- value_form(paye_stats %>% filter( new_date == max(new_date))  %>% select(uk_change_since_feb20),s=signif_thous)
  
  paye_p_feb20_uk <- perc_form(paye_stats %>% filter( new_date == max(new_date)) %>% select(uk_percentage_change_since_feb20),d = digits_perc)

```

<a href="#top">Back to top</a>

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

## Payrolled employees {.tabset}

<br/>

The count of payrolled employees from HMRC's Pay As You Earn (PAYE) RTI dataset offers a timely measure of labour market trends:

-   Early estimates indicate that there were around `r paye_level` million payrolled employees living in London in `r paye_newmonth`, `r condi_text(paye_d_month,"noun")` of around `r abs2(paye_d_month)`, or `r abs2(paye_p_month)`%, on the previous month.

-   The latest London estimate represents `r condi_text(paye_d_year,"noun")` of `r abs2(paye_d_year)`, or `r abs2(paye_p_year)`%, on the previous year (`r paye_lastyearmonth`) against a UK average increase of `r paye_p_year_uk`% (see charts).

-   Relative to pre-pandemic (February 2020) levels, the number of payrolled employees in London was `r condi_text(paye_d_feb20,"up")` by `r abs2(paye_d_feb20)`, or `r abs2(paye_p_feb20)`%. This compares to `r condi_text(paye_p_feb20_uk,"noun")` of `r abs2(paye_p_feb20_uk)`% across the UK on average.

<a href="#top">Back to top</a>

### Change on previous year

```{r PAYE chart, echo=FALSE,fig.cap = payecap, out.width='100%' }
  
  # Plotting process:
  ## First set the relevant colour palette and them
  ## Produce the ggplot and save it on the shared drive
  ## Produce the interactive ggplotly chart for the markdown.
  
  pal <- gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1))
  theme_set(theme_gla(gla_theme = "default"))
  
  paye_stats_chart <- paye_stats %>%
    pivot_longer(cols = ends_with("_change"), names_to = "geography", values_to = "change" ) %>%
    mutate( geography_name = case_when( grepl("lon",geography) ~ "London",
                                        grepl("uk",geography) ~ "United Kingdom")) %>%
    mutate(var_type = sub(".*?_",'',geography)) %>% 
    filter( new_date >= "2016-01-01" & var_type == "annual_percentage_change") %>%
    ggplot(mapping = aes(x = new_date, y = change,
                         colour = geography_name, group = geography_name,
                         text = paste(
                           geography_name, "\n",
                           format(new_date,'%B %Y'), "\n",
                           "Change: ", perc_form(change),"%", "\n",
                           sep = ""))) +
    ggla_line(aes(size= geography_name)) +
    geom_vline(aes(xintercept = as.numeric(ymd("2020-03-01"))),
               linetype = "dotted",
               size = 1 * mm_to_pt,
               colour = rgb(166,166,166,maxColorValue = 255)) + # mark lockdowns start
    scale_size_manual(values = c(2 * mm_to_pt, 1 * mm_to_pt)) +
    scale_colour_manual(values = pal) +
    ggla_highlight(filter_type = "end") +
    ggla_highlight(mapping = aes(label = paste0(format(change, digits = 1),"%")),
                   geom = GeomGLATextHighlight, filter_type = "end",  size = 4.5,
                   position = position_nudge(y = c(+0.4,+0.4)))+
    coord_cartesian(clip = 'off') +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_y_continuous(expand = c(0, 0), labels = dollar_format(prefix = "",
                                                                suffix = "%",
                                                                largest_with_cents = 1),
                       limits = c(-6,8)) +
    scale_x_date( date_breaks = "1 year",
                  date_labels = "%b %Y",
                  expand = expansion( mult = c(0.05,0.05))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Payrolled employees, change on previous year",
         subtitle = paste0("Latest data for period ", paye_stats$date[paye_stats$new_date == max(paye_stats$new_date)]),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live. March 2020 indicated by dotted line.")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye")
  
  # Plotly chart
  
  
    LMU_plotly_settings(ch_name = paye_stats_chart,
                        title_text = 'paste0("Payrolled employees, change on previous year")',
                        subtitle_text = 'paste0("Latest data for period ", paye_stats$date[paye_stats$new_date == max(paye_stats$new_date)])',
                      hover_mode = "x")
  
  payecap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.","<br>","<br>", "Note: Estimates are based on where employees live. March 2020 indicated by dotted line.")

```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

### Change since February 2020, NUTS2 regions

```{r paye bar feb20, , echo=FALSE,fig.cap = payebarcapfeb, out.width='100%'}
  
  
  pal <- gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1))
  theme_set(theme_gla(gla_theme = "default"))
  
  paye_stats_barchart_feb20 <- paye_nuts2_stats %>%
    filter( new_date == max(new_date)) %>%
    ungroup() %>% 
    mutate(chart_ranking = case_when( area == "UK" ~ 1,
                                      area == "London" ~ 2,
                                      TRUE ~ dense_rank(desc(change_perc_since_feb20))+2)) %>% 
    ggplot(mapping = aes(x =  reorder(area, -chart_ranking), y = change_perc_since_feb20,
                         colour = area, group = area, fill=area,
                         text = paste(
                           area, "\n",
                           "Change: ", perc_form(change_perc_since_feb20),"%", "\n",
                           sep = ""))) +
    geom_bar(stat="identity",width=0.5)+
    geom_text(aes(label=paste(format(round(change_perc_since_feb20,1), digits = 2), "%"),
                  y = change_perc_since_feb20-0.13*((change_perc_since_feb20)/abs(change_perc_since_feb20))),
              color=c("white","white","white","white","white","white","black"))+ #cannot use vjust with ggplotly
    scale_color_manual(values = c(pal[1],pal[1],pal[1],pal[1],pal[1],pal[1],pal[2]), aesthetics = "colour") +
    scale_fill_manual(values = c(pal[1],pal[1],pal[1],pal[1],pal[1],pal[1],pal[2]), aesthetics =  "fill") +
    coord_cartesian(clip = 'off') +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_y_continuous(labels = dollar_format(prefix = "",
                                              suffix = "%",
                                              largest_with_cents = 1),
                       limits = c(-0.5,3)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"),axis.text=element_text(size=12))+
    labs(title =  "Payrolled employees, change since February 2020 by NUTS2 region",
         subtitle = paste0("Latest data for period ", paye_nuts2_stats$date[paye_nuts2_stats$new_date == max(paye_nuts2_stats$new_date)]),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") + 
    theme(legend.position = "none",
          plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_nuts2_feb20")
  
  LMU_plotly_settings(ch_name = paye_stats_barchart_feb20,
                      title_text = 'paste0("Payrolled employees, change since February 2020 by NUTS2 region")',
                      subtitle_text = 'paste0("Latest data for period ", paye_nuts2_stats$date[paye_nuts2_stats$new_date == max(paye_nuts2_stats$new_date)])',
                      hover_mode = "closest") %>% 
    hide_legend()
  
  payebarcapfeb <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.","<br>","<br>", "Note: Estimates are based on where employees live.")


```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

### Change on previous year, NUTS2 regions

```{r paye bar, , echo=FALSE,fig.cap = payebarcap, out.width='100%' }

  
  pal <- gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1))
  theme_set(theme_gla(gla_theme = "default"))
  
  paye_stats_barchart <- paye_nuts2_stats %>%
    filter(new_date == max(new_date)) %>%
    ungroup() %>% 
    mutate(chart_ranking = case_when( area == "UK" ~ 1,
                                      area == "London" ~ 2,
                                      TRUE ~ dense_rank(desc(annual_change))+2)) %>% 
    ggplot(mapping = aes(x =  reorder(area, -chart_ranking), y = annual_change,
                         colour = area, group = area, fill=area,
                         text = paste(
                           area, "\n",
                           "Change: ", perc_form(annual_change),"%", "\n",
                           sep = ""))) +
    geom_text(aes(label=paste0(format(round(annual_change,1), digits = 2), "%"), 
                  y = annual_change-0.15*min(annual_change)), 
              color=c("white","white","white","white","white","white","black"))+ #cannot use vjust with ggplotly
    geom_bar(stat="identity",width=0.5)+
    scale_color_manual(values = c(pal[1],pal[1],pal[1],pal[1],pal[1],pal[1],pal[2]), aesthetics = "colour") +
    scale_fill_manual(values = c(pal[1],pal[1],pal[1],pal[1],pal[1],pal[1],pal[2]), aesthetics = "fill") +
    scale_size_manual(values = c(4 * mm_to_pt, 2 * mm_to_pt)) +
    coord_cartesian(clip = 'off') +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_y_continuous(labels = dollar_format(prefix = "",
                                              suffix = "%",
                                              largest_with_cents = 1),
                       limits = c(0,10)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
    
    theme(plot.margin = unit(c(1,1,1,1), "cm"),axis.text=element_text(size=12))+
    labs(title =  "Payrolled employees, change on previous year by NUTS2 region",
         subtitle = paste0("Latest data for period ", paye_nuts2_stats$date[paye_nuts2_stats$new_date == max(paye_nuts2_stats$new_date)]),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") + 
    theme(legend.position = "none") +
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_nuts2_yoy")
  
  LMU_plotly_settings(ch_name = paye_stats_barchart,
                      title_text = 'paste0("Payrolled employees, change on previous year by NUTS2 region")',
                      subtitle_text = 'paste0("Latest data for period ", paye_nuts2_stats$date[paye_nuts2_stats$new_date == max(paye_nuts2_stats$new_date)])',
                      hover_mode = "closest") %>% 
    hide_legend()
  
  payebarcap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.","<br>","<br>", "Note: Estimates are based on where employees live.")


```



<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

## Additional payrolled employee statistics {.tabset}

<br/>

The tabs below are each updated once per quarter, as new data is released by the ONS/HMRC.

<br/>


### Change by age group


```{r paye age stats,echo=FALSE}
  
  #Max change in London
  paye_age_max_perc_lon <- perc_form(paye_nuts1age_stats %>% ungroup() %>% filter(new_date == max(new_date) & area == "London" & !(age_group %in% c("Aged: 0-17"))) %>% filter(change_perc_since_feb20 == max(change_perc_since_feb20) ) %>% select(change_perc_since_feb20),d = digits_perc)
  
  paye_age_max_age_lon <- as.character(paye_nuts1age_stats %>% ungroup() %>% filter(new_date == max(new_date) & area == "London" & !(age_group %in% c("Aged: 0-17"))) %>% filter(change_perc_since_feb20 == max(change_perc_since_feb20) ) %>% select(age_group))
  
  paye_age_max_l_perc_uk <- perc_form(paye_nuts1age_stats %>% ungroup() %>% filter(new_date == max(new_date) & area == "United Kingdom" & !(age_group %in% c("Aged: 0-17"))) %>% filter(age_group == paye_age_max_age_lon ) %>% select(change_perc_since_feb20),d = digits_perc)
  
  #Min change in London
  paye_age_min_perc_lon <- perc_form(paye_nuts1age_stats %>% ungroup() %>% filter(new_date == max(new_date) & area == "London" & !(age_group %in% c("Aged: 0-17"))) %>% filter(change_perc_since_feb20 == min(change_perc_since_feb20) ) %>% select(change_perc_since_feb20),d = digits_perc)
  
  paye_age_min_age_lon <- as.character(paye_nuts1age_stats %>% ungroup() %>% filter(new_date == max(new_date) & area == "London" & !(age_group %in% c("Aged: 0-17"))) %>% filter(change_perc_since_feb20 == min(change_perc_since_feb20) ) %>% select(age_group))
  
  paye_age_min_l_perc_uk <- perc_form(paye_nuts1age_stats %>% ungroup() %>% filter(new_date == max(new_date) & area == "United Kingdom" & !(age_group %in% c("Aged: 0-17"))) %>% filter(age_group == paye_age_min_age_lon ) %>% select(change_perc_since_feb20),d = digits_perc)
  
  #Specifically the 50-64 group
  paye_age_5064_perc_lon <- perc_form(paye_nuts1age_stats %>% ungroup() %>% filter(new_date == max(new_date) & area == "London" & age_group %in% c("Aged: 50-64")) %>% filter(change_perc_since_feb20 == max(change_perc_since_feb20) ) %>% select(change_perc_since_feb20),d = digits_perc)
  
    paye_age_5064_perc_uk <- perc_form(paye_nuts1age_stats %>% ungroup() %>% filter(new_date == max(new_date) & area == "United Kingdom" & age_group %in% c("Aged: 50-64")) %>% filter(change_perc_since_feb20 == max(change_perc_since_feb20) ) %>% select(change_perc_since_feb20),d = digits_perc)

```

<br/>

Recent changes in the number of payrolled employees vary by age group. Comparing **`r newest_period_paye_age`** to pre-pandemic (February 2020) levels:

- The number of payrolled employees "Aged: 50-64" in London was `r condi_text(paye_age_5064_perc_lon,"up")` by `r abs2(paye_age_5064_perc_lon)`%, while the number of employees "`r paye_age_min_age_lon`" was `r condi_text(paye_age_min_perc_lon,"up")` by `r abs2(paye_age_min_perc_lon)`%.

- For the UK overall, the number of payrolled employees in those two age groups saw `r condi_text(paye_age_5064_perc_uk,"noun")` of `r abs2(paye_age_5064_perc_uk)`% and `r condi_text(paye_age_min_l_perc_uk,"noun")` of `r abs2(paye_age_min_l_perc_uk)`%, respectively.

<a href="#top">Back to top</a>

```{r paye age region, echo=FALSE, fig.cap=paye_agecap, out.width='100%' }
  
  ### Change in PAYE employees by age group since Feb2020
  pal <- gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1))
  theme_set(theme_gla(gla_theme = "default"))
  
  
  paye_age_bars <- paye_nuts1age_stats %>%
    group_by(area) %>% 
    filter( (new_date == max(new_date)) & 
              !(age_group %in% c("Aged: 0-17"))
            & area %in% c("London", "United Kingdom")) %>%  
    mutate(chart_ranking = rank((age_group))) %>% 
    ungroup() %>% 
    ggplot(mapping = aes(x = reorder(age_group,chart_ranking), 
                         y = change_perc_since_feb20, 
                         colour = area , fill=area,
                         text = paste(age_group, "\n",
                                      area, "\n",
                                      "Change: ", perc_form(change_perc_since_feb20),"%", "\n",
                                      sep = ""))) +
    geom_bar(stat = "identity", position = position_dodge(), width = 0.4)+
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_colour_manual(values = pal) +
    scale_fill_manual(values = pal) +
    theme_set(theme_gla(gla_theme = "default")) +
    scale_y_continuous(limits = c(-2, 7), labels = dollar_format(prefix = "", 
                                                                 suffix = "%", 
                                                                 largest_with_cents = 1)) +
    theme(axis.text.x = element_text( hjust=1, vjust=0.5)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title = "Payrolled employees, change since February 2020 by age group",
         subtitle = paste0("Latest data for period ", newest_period_paye_age),
         caption = "\nSource: HM Revenue and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live.") +
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_age_feb20")
  
  LMU_plotly_settings(ch_name = paye_age_bars,
                      title_text = 'paste0("Payrolled employees, change since February 2020 by age group")',
                      subtitle_text = 'paste0("Latest data for period ", newest_period_paye_age)',
                      hover_mode = "closest") 
 
  paye_agecap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.","<br>","<br>", "Note: Estimates are based on where employees live.")

  
```





<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

### Change by local authority

```{r paye la stats,echo=FALSE}

  paye_la_max_val <- perc_form(paye_la_stats %>% filter(new_date == max(new_date)) %>% filter(change_perc_since_feb20 == max(change_perc_since_feb20)) %>% select(change_perc_since_feb20),d = digits_perc)
  
  paye_la_max_area <- paye_la_stats %>% filter(new_date == max(new_date)) %>% filter(change_perc_since_feb20 == max(change_perc_since_feb20)) %>% select(area)
  
  paye_la_min_val <- perc_form(paye_la_stats %>% filter(new_date == max(new_date)) %>% filter(change_perc_since_feb20 == min(change_perc_since_feb20)) %>% select(change_perc_since_feb20),d = digits_perc)
  
  paye_la_min_area <- paye_la_stats %>% filter(new_date == max(new_date)) %>% filter(change_perc_since_feb20 == min(change_perc_since_feb20)) %>% select(area)
  
  paye_la_count_below_feb20 <- paye_la_stats %>% filter(new_date == max(new_date)) %>% mutate(count_below_feb20 = sum(change_perc_since_feb20<0)) %>% filter(row_number()==1) %>%  select(count_below_feb20)
  
  paye_la_count_tot <- paye_la_stats %>% filter(new_date == max(new_date)) %>% add_count() %>% filter(row_number()==1) %>%  select(n)

```

<br/>

There is considerable variation in the change in payrolled employees by London authority. Comparing **`r newest_period_paye_la`** to pre-pandemic (February 2020) levels:

-   The number of payrolled employees living in `r paye_la_max_area` was `r condi_text(paye_la_max_val,"up")` by `r abs2(paye_la_max_val)`%, while the number living in `r paye_la_min_area` was `r condi_text(paye_la_min_val,"up")` by `r abs2(paye_la_min_val)`%.

-   Overall, the number of payrolled employees were still below pre-pandemic levels in `r paye_la_count_below_feb20` out of `r paye_la_count_tot` London authorities (including City of London, see map).

<a href="#top">Back to top</a>

```{r results="asis", echo=FALSE}
# This code is needed to force background of Leaflet map to be white
cat("
<style>
.leaflet-container {
    background: #FFF;
}
</style>
")
```

```{r paye borough map, echo=FALSE,fig.cap = map_cap, out.width='100%' }
  
  # Produces interactive map of boroughs with change in payrolled employees
  
  #Read the shape file from the drive
  boroughs <- readOGR(dsn =  here("INPUT","statistical-gis-boundaries-london","ESRI"),
                      layer = "London_Borough_Excluding_MHW",
                      verbose = FALSE) %>%
    spTransform(CRS("+proj=longlat +datum=WGS84"))
  
  # Prepare data
  paye_la_stats_geo <- paye_la_stats %>%
    mutate(tooltip= paste("Change: ", perc_form(change_perc_since_feb20),"%", "\n", sep = "")) %>% 
    rename(GSS_CODE=gss_code, value=change_perc_since_feb20) %>% #Necessary since the shape files use upper caps variable names
    filter(new_date == max(new_date)) 
  
  #Make a function to make things easier
  
  map_function <- function(data, polygons, bins, palette, map_title){
  
    #Join data to polygons
    polygons@data <- left_join(polygons@data, data, by="GSS_CODE")
    
    #Create the palette
    pal <- colorBin(palette, domain = polygons$value, bins = bins)
    
    #Make tool tip
    labels <- sprintf(
      "<strong>%s</strong><br/>%s",
      polygons$NAME, polygons$tooltip
    ) %>% lapply(htmltools::HTML)
  
    
    #Make map
    map_output1 <- leaflet() %>%
      addPolygons(data = polygons,
                  fillColor = ~pal(value),
                  weight = 1,
                  opacity = 1,
                  color = "grey",
                  fillOpacity = 0.8,
                  label = labels,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal", padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")) %>%
      addLegend(pal = pal, values = polygons$value, opacity = 0.8,
                title = map_title,
                position = "bottomright", labFormat = labelFormat(between = "% to ", suffix="%"))
    
      
    # Find default bounds
    lng_b <- map_output1[["x"]][["limits"]][["lng"]]
    lat_b <- map_output1[["x"]][["limits"]][["lat"]]
    bounds_txt <- paste0("function(btn, map){ map.flyToBounds([[",lat_b[1],",",lng_b[1],"],[",lat_b[2],",",lng_b[2],"]]);}")
    
    map_output <- map_output1 %>% 
      addEasyButton(easyButton(
        icon="fa-globe", title="Default zoom",
        onClick=JS(bounds_txt)))
    
    #return(bounds_txt)
      
    return(map_output)
  }
  
  # NB: THE BINS BELOW MUST BE CHANGED WHEN VALUES CHANGE!
  bins <- c(-8,-6,-4,-2, 0,2,4,6,8)
  
  # Colour palette, title and captions
  map_palette <- gla_pal(palette_type = "diverging", main_colours = c("red","blue"), n = 8, remove_margin = "both")
  map_title <- paste0("Change since","<br>" ,"February 2020 (%)")
  map_cap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information. Contains Ordnance Survey data Crown copyright and database rights [2015].","<br>","<br>", "Note: Estimates are based on where employees live.")
  
  #Run Map
  map_function(paye_la_stats_geo, boroughs, bins, map_palette, map_title)

```


<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>


### Change by industry

```{r paye industry stats,echo=FALSE}
  
  # Find industries with lowest and highest growth in recent data
  
  sector_thresh_paye <- 25000
  
  lowest_growth_ind_paye <- paye_nuts1ind_stats %>% 
    filter(new_date == max(new_date) & geography_name == "London" & emp_level>=sector_thresh_paye & !is.na(change_perc_since_feb20)) %>%
    slice_min(change_perc_since_feb20,n=3) 
  
  highest_growth_ind_paye <- paye_nuts1ind_stats %>% 
    filter(new_date == max(new_date) & geography_name == "London" & emp_level>=sector_thresh_paye & !is.na(change_perc_since_feb20)) %>%
    slice_max(change_perc_since_feb20,n=3) 
  
  ## Find industry names and growth figures
  
  for (measure in c("lowest","highest")) {
    
    dat_temp <- eval(as.name(paste0(measure,"_growth_ind_paye")))
    
    for (num_la in 1:3) {
      
      growth_x_name <- dat_temp %>% filter(row_number()==num_la) %>% pull(industry_name_simple)
      
      growth_x_p <- perc_form(dat_temp %>% filter(row_number()==num_la) %>% select(change_perc_since_feb20),d = 1)
      
      assign(paste0(measure,"_growth_ind_paye_",num_la,"_name"),growth_x_name)
      assign(paste0(measure,"_growth_ind_paye_",num_la,"_p"),growth_x_p)
      remove(growth_x_name)
      remove(growth_x_p)
    }
    remove(dat_temp)
  }

```

<br/>

Some industries have yet to recover from the pandemic. Comparing **`r newest_period_paye_ind`** to pre-pandemic (February 2020) levels:

- `r highest_growth_ind_paye_1_name` saw the highest percentage growth in payrolled employees at `r highest_growth_ind_paye_1_p`%, followed by `r highest_growth_ind_paye_2_name` (`r highest_growth_ind_paye_2_p`%) and `r highest_growth_ind_paye_3_name` (`r highest_growth_ind_paye_3_p`%).

-  On the other hand, `r lowest_growth_ind_paye_1_name` saw the lowest percentage growth with `r condi_text(lowest_growth_ind_paye_1_p,"noun")` of `r abs2(lowest_growth_ind_paye_1_p)`%, followed by `r lowest_growth_ind_paye_2_name` (`r condi_text(lowest_growth_ind_paye_2_p,"up")` by `r abs2(lowest_growth_ind_paye_2_p)`%) and `r lowest_growth_ind_paye_3_name` (`r condi_text(lowest_growth_ind_paye_3_p,"up")` by `r abs2(lowest_growth_ind_paye_3_p)`%).

<a href="#top">Back to top</a>


```{r paye industry region, echo=FALSE, fig.cap=paye_seccap, out.width='100%' }
  
  pal <- gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1))
  theme_set(theme_gla(gla_theme = "default"))
  
  # Select industries large in London, here 25k
  lon_large_inds_paye <- paye_nuts1ind_stats %>%
    filter( emp_level >=sector_thresh_paye 
            & geography_name =="London" & new_date == max(new_date)) %>% 
    select(industry_name_simple)
  
  lon_large_inds_paye <- unlist(lon_large_inds_paye)
  
  paye_industry_bar <- paye_nuts1ind_stats %>%
    filter(new_date == max(new_date) & industry_name_simple %in% lon_large_inds_paye) %>% 
    group_by(geography_name) %>% #To ensure chart ranking is correct, make rank based on London and assign within sector
    mutate(chart_ranking = case_when(
      geography_name=="London" ~ dense_rank(desc(change_perc_since_feb20)))) %>% 
    group_by(industry_name_simple) %>% 
    mutate(chart_ranking=min(chart_ranking,na.rm=TRUE)) %>% 
    ungroup() %>% 
    arrange(chart_ranking) %>% 
    ggplot(mapping = aes(x =  factor(reorder(industry_name_simple,-chart_ranking)), 
                         y = change_perc_since_feb20, 
                         colour = factor(reorder(geography_name,desc(geography_name))) ,#since horizontal bar reverses orders, we need to reverse too
                         fill=factor(reorder(geography_name,desc(geography_name))),
                         width = 0.5,
                         text = paste(industry_name_simple, "\n",
                                      geography_name, "\n",
                                      "Change: ", perc_form(change_perc_since_feb20),"%", "\n",
                                      sep = ""))) +
    geom_bar(stat = "identity", position = position_dodge()) +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_color_manual(values = rev(pal), aesthetics = "colour")+
    scale_fill_manual(values = rev(pal), aesthetics = "fill")+
    theme_set(theme_gla(gla_theme = "default", y_label_length=100)) + #GLA theme and removes lines below y-axis labels
    scale_y_continuous(limits = c(-14, 12), labels = dollar_format(prefix = "", 
                                                                   suffix = "%", 
                                                                   largest_with_cents = 1)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    scale_x_discrete(expand = c(0,0)) +
    theme(panel.grid.major.y = element_blank(), #removed y grid
          panel.grid.minor.y = element_blank(), # removes small y grid
          panel.grid.major.x = element_line( size=.5 ), # removes x grid
          axis.text.y = ggplot2::element_text( # ensures  y axis labels stay outside chart
            hjust = 0, vjust = 0.5,
            margin = ggplot2::margin(t = 0, r = 0, b = 0, l = 0,
                                     unit = "pt")),
          axis.ticks.length.y = ggplot2::unit(x = 0, units = "pt")) + #removes ticks from y axis
    coord_flip()+
    guides(colour=guide_legend(reverse=TRUE),
           fill=guide_legend(reverse=TRUE)) +
    labs(title = paste0("Payrolled employees, change since February 2020 by selected sector"),
         subtitle = paste0("Latest data for period ", newest_period_paye_ind),
         caption = "\nSource: HM Revenues and Customs – Pay As You Earn Real Time Information.\n\nNote: Estimates are based on where employees live. Chart excludes sectors with fewer than 25,000 payrolled employees in London.")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "paye_industries")
  
  LMU_plotly_settings(ch_name = paye_industry_bar,
                      title_text = 'paste0("Payrolled employees, change since February 2020 by selected sector")',
                      subtitle_text = 'paste0("Latest data for period ", newest_period_paye_ind)',
                      hover_mode = "closest") %>% 
    layout(xaxis = list(showgrid=TRUE),
           yaxis = list(showgrid=FALSE)) %>% 
    reverse_legend_labels()
  
  
  paye_seccap <- paste0("Source: HM Revenue and Customs – Pay As You Earn Real Time Information.","<br>","<br>", "Note: Estimates are based on where employees live. Excludes sectors with fewer than 25,000 payrolled employees in London.")

```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>





```{r, emp_figures, echo=FALSE}
  
  emp_rate_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Level" & measures == 20207)  %>% select(total_in_employment_aged_16_to_64),d = digits_perc)
  
  emp_pp_quart_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom"  & value_type_name == "Change on quarter" & measures == 20207)  %>% select(total_in_employment_aged_16_to_64),d = digits_perc)
  
  emp_pp_year_uk <-perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom"  & value_type_name == "Change on year" & measures == 20207) %>% select(total_in_employment_aged_16_to_64),d = digits_perc)

```

## Employment rate

<br/>

Employment measures the number of people aged 16 and over in paid work and those who had a job that they were temporarily away from. The employment rate is the proportion of people aged between 16 and 64 years who are in employment.

For `r lfs_lastmonth` to `r lfs_newmonth`:

-   The 16-64 employment rate in London was estimated at `r emp_rate`%; this represents `r condi_text(emp_pp_quart,"noun")` of `r abs2(emp_pp_quart)` percentage points (pp) on the previous quarter and `r condi_text(emp_pp_year,"noun")` of `r abs2(emp_pp_year)`pp from a year earlier.

-   The overall UK employment rate was estimated at `r emp_rate_uk`%, unchanged on the quarter but `r condi_text(emp_pp_year_uk,"noun")` of `r abs2(emp_pp_year_uk)`pp on the year.

<a href="#top">Back to top</a>

```{r employ chart, echo=FALSE,fig.cap = empcap, out.width='100%'}
  ### The below should be the relevant chart
  employment_rate <- GLALineChart(data_set = lfs_stats, y_var = total_in_employment_aged_16_to_64, 
                           title = "Employment rate (% of working age population)",
                           caption = "\nSource: ONS Labour Force Survey.\n\nNote: The margin of error is +/- 1.3% for London and +/- 0.4% for the UK. \nMarch 2020 indicated by dotted line.",
                           chart_name = "employment", y_limits = c(70,80), nudge_y = c(+0.4, -0.4)) 
  
  LMU_plotly_settings(ch_name = employment_rate,
                      title_text = 'paste0("Employment rate (% of working age population)")',
                      subtitle_text = 'paste0("Latest data for period ", lfs_newmonth)',
                      hover_mode = "x") 

  
  empcap <- paste0("Source: ONS Labour Force Survey.","<br>","<br>", "Note: The margin of error is +/- 1.4% for London and +/- 0.4% for the UK. March 2020 indicated by dotted line.")


```

```{r, unem_figures, echo=FALSE}

  unem_pp_quart_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Change on quarter" & measures == 20207) %>% select(total_unemployed_aged_16_and_over),d = digits_perc)
  
  
  unem_pp_year_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Change on year" & measures == 20207)  %>% select(total_unemployed_aged_16_and_over),d = digits_perc)

```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

## Unemployment rate

<br/>

Unemployment measures people without a job who have been actively seeking work within the last four weeks and are available to start work within the next two weeks. The unemployment rate is the proportion of the economically active population who are unemployed.

For `r lfs_lastmonth` to `r lfs_newmonth`:

-   The unemployment rate for London was estimated at `r unem_rate`%; this represents `r condi_text(unem_pp_quart,"noun")` of `r abs2(unem_pp_quart)`pp on the previous quarter and `r condi_text(unem_pp_year,"noun")` of `r abs2(unem_pp_year)`pp from a year earlier.

-   The UK unemployment rate was estimated at `r unem_rate_uk`%, `r condi_text(unem_pp_quart_uk,"noun")` of `r abs2(unem_pp_quart_uk)`pp from the previous quarter and `r condi_text(unem_pp_year_uk,"noun")` of `r abs2(unem_pp_year_uk)`pp on the year.

<a href="#top">Back to top</a>

```{r unemployed chart, echo=FALSE,fig.cap = unempcap, out.width='100%'}

  unemployment_rate <- GLALineChart( data_set = lfs_stats, y_var = total_unemployed_aged_16_and_over, 
                               title = "Unemployment rate (% of economically active)",
                               caption = "\nSource: ONS Labour Force Survey.\n\nNote: The margin of error is +/- 0.8% for London and +/- 0.2% for the UK. \nMarch 2020 indicated by dotted line.",
                               chart_name = "unemployment", y_limits = c(0,8), nudge_y = 0.4)

  LMU_plotly_settings(ch_name = unemployment_rate,
                      title_text = 'paste0("Unemployment rate (% of economically active)")',
                      subtitle_text = 'paste0("Latest data for period ", lfs_newmonth)',
                      hover_mode = "x") 

  
  unempcap <- paste0("Source: ONS Labour Force Survey.","<br>","<br>", "Note: The margin of error is +/- 0.8% for London and +/- 0.2% for the UK. March 2020 indicated by dotted line.")
  


```

```{r inact_figures,echo=FALSE}
  
  inact_rate <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London" & value_type_name == "Level" & measures == 20207)  %>% select(total_economically_inactive_aged_16_to_64),d= digits_perc)
    
  inact_pp_quart <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London" & value_type_name == "Change on quarter" & measures == 20207) %>% select(total_economically_inactive_aged_16_to_64),d= digits_perc)
    
  inact_pp_year <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "London" & value_type_name == "Change on year" & measures == 20207)  %>% select(total_economically_inactive_aged_16_to_64),d= digits_perc)
  
  inact_rate_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Level" & measures == 20207)  %>% select(total_economically_inactive_aged_16_to_64),d= digits_perc)
    
  inact_pp_quart_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Change on quarter" & measures == 20207) %>% select(total_economically_inactive_aged_16_to_64),d= digits_perc)
    
  inact_pp_year_uk <- perc_form(lfs_stats %>% filter(sex_name == "Total" & date == max(date) & geography_name == "United Kingdom" & value_type_name == "Change on year" & measures == 20207)  %>% select(total_economically_inactive_aged_16_to_64),d= digits_perc)

```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

## Economic inactivity rate

<br/>

The economic inactivity rate is the proportion of 16 to 64 year olds not in work and either not looking for or unable to work. This group includes some students, people who are looking after family/home, and people who are too ill to work (most of whom are long-term sick).

For `r lfs_lastmonth` to `r lfs_newmonth`:

-   The rate of economic inactivity in London was estimated at `r inact_rate`%; this represents `r condi_text(inact_pp_quart,"noun")` of `r abs2(inact_pp_quart)`pp on the previous quarter and `r condi_text(inact_pp_year,"noun")` of `r abs2(inact_pp_year)`pp from a year earlier.

-   The UK rate of economic inactivity was `r inact_rate_uk`%. This represents `r condi_text(inact_pp_quart_uk,"noun")` of `r abs2(inact_pp_quart_uk)`pp on the previous quarter and `r condi_text(inact_pp_year_uk,"noun")` of `r abs2(inact_pp_year_uk)`pp on the year.

<a href="#top">Back to top</a>

```{r inactive chart, echo=FALSE,fig.cap = inactcap, out.width='100%'}

  econ_inactive <- GLALineChart( data_set = lfs_stats, y_var = total_economically_inactive_aged_16_to_64, 
                              title =  "Economic inactivity (% of working age population)",
                               caption = "\nSource: ONS Labour Force Survey.\n\nNote: The margin of error is not published for London, the UK margin is +/- 0.4%. \nMarch 2020 indicated by dotted line.",
                              chart_name = "inact", y_limits = c(15,25), nudge_y = c(-0.5, +0.5))

  LMU_plotly_settings(ch_name = econ_inactive,
                      title_text = 'paste0("Economic inactivity (% of working age population)")',
                      subtitle_text = 'paste0("Latest data for period ", lfs_newmonth)',
                      hover_mode = "x") 

  inactcap <- paste0("Source: ONS Labour Force Survey.","<br>","<br>", "Note: The margin of error is not published for London, the UK margin is +/- 0.4%. March 2020 indicated by dotted line.")

```

```{r claim_figures, echo=FALSE}

  claim_period <- claimant_count_stats_long %>%  filter(date == max(date)) %>% filter(row_number()==1) %>% mutate(date = format(date, '%B %Y'))  %>% pull(date)
  
  claim_level <- value_form(claimant_count_stats_long %>% filter( sex_name == "Total" & geography_name == "London" & date == max(date) & age_name == "All categories: Age 16+" & measure_name == "claimant_count") %>% select(measure_value),s = signif_thous)
    
  claim_rate <- perc_form(claimant_count_stats_long %>% filter( sex_name == "Total" & geography_name == "London" & date == max(date) & age_name == "All categories: Age 16+" & measure_name == "claimants_as_a_proportion_of_residents_aged_16_64") %>% select(measure_value),d = digits_perc)
  
  claim_d_year <- value_form(claimant_count_stats_long %>% filter( sex_name == "Total" & geography_name == "London" & date == max(date) & age_name == "All categories: Age 16+" & measure_name == "claimant_count") %>% select(change_year),s = signif_thous)
    
  claim_p_year <- perc_form(claimant_count_stats_long %>% filter( sex_name == "Total" & geography_name == "London" & date == max(date) & age_name == "All categories: Age 16+" & measure_name == "claimant_count") %>% select(change_year_percent),d = digits_perc)
    
  claim_d_year_uk <- value_form(claimant_count_stats_long %>% filter( sex_name == "Total" & geography_name == "United Kingdom" & date == max(date) & age_name == "All categories: Age 16+" & measure_name == "claimant_count") %>% select(change_year),s = signif_thous)
    
  claim_p_year_uk <- perc_form(claimant_count_stats_long %>% filter( sex_name == "Total" & geography_name == "United Kingdom" & date == max(date) & age_name == "All categories: Age 16+" & measure_name == "claimant_count") %>% select(change_year_percent),d = digits_perc)

```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

## Claimant count {.tabset}

<br/>

The claimant count is a measure of the number of people claiming benefits principally for the reason of being unemployed. It includes people claiming Jobseeker's Allowance and those claiming Universal Credit who are required to seek work.

The latest data for `r claim_period` show that:

-   There were `r claim_level` people claiming unemployment-related benefits in London - equal to a claimant unemployment rate (as a proportion of residents aged 16 to 64) of `r claim_rate`%.

-   The number of claimants in London has `r condi_text(claim_d_year,"increase")` by `r abs2(claim_d_year)`, or `r abs2(claim_p_year)`%, on the year, compared to `r condi_text(claim_d_year,"noun")` of `r abs2(claim_d_year_uk)`, or `r abs2(claim_p_year_uk)`%, in the UK overall.

<a href="#top">Back to top</a>

### Rate of residents aged 16-64

```{r claimant chart, echo=FALSE,fig.cap = claimcap, out.width='100%'}
  
  ### Create claimant count charts
  
  claimant_count_percent <- GLALineChart( data_set = claimant_count_stats_wide, y_var = claimants_as_a_proportion_of_residents_aged_16_64, 
                                          suffix = "%", lfs_or_claims = "claims", title =  "Claimant count (as a % of residents aged 16 to 64)",
                                          caption = "\nSource: ONS Claimant Count by sex and age (NSA).\n\nNote: may include some employed claimants on low hours or earnings. \nMarch 2020 indicated by dotted line.",
                                          chart_name = "claimant_count_per", y_limits = c(0,10), nudge_y = 0.5)

  LMU_plotly_settings(ch_name = claimant_count_percent,
                      title_text = 'paste0("Claimant count (as a % of residents aged 16 to 64)")',
                      subtitle_text = 'paste0("Latest data for period ", claim_period)',
                      hover_mode = "x") 
  
    claimcap <- paste0("Source: ONS Claimant Count by sex and age (NSA).","<br>","<br>", "Note: may include some employed claimants on low hours or earnings. March 2020 indicated by dotted line.")
  
  ### Manually plot total London claimants [IS NOT INCLUDED IN MARKDOWN]
  
  new_release_text <- claimant_count_stats_wide$date_name[claimant_count_stats_wide$date == max(claimant_count_stats_wide$date)]
  
  
  claimant_count_total <- claimant_count_stats_wide %>%
    filter( geography_name == "London" & sex_name == "Total" & !is.na(claimant_count) 
            & age_name == "All categories: Age 16+") %>% 
    ggplot(mapping = aes(x = date, y = claimant_count, 
                         colour = geography_name, group = geography_name)) +
    ggla_line(aes(size= geography_name)) +
    scale_size_manual(values = c(4 * mm_to_pt, 2 * mm_to_pt)) +
    scale_colour_manual(values = pal) +
    ggla_highlight(filter_type = "end") +
    ggla_highlight(mapping = aes(label = format(claimant_count, big.mark = ",")),
                   geom = GeomGLATextHighlight, filter_type = "end",  size = 4.5,
                   position = position_nudge(y = 20000),check_overlap = TRUE)+
    coord_cartesian(clip = 'off') +
    ggla_axisat0() +
    scale_y_continuous(expand = c(0, 0), labels = dollar_format(prefix = "", 
                                                                suffix = "", 
                                                                largest_with_cents = 1), 
                       limits = c(0,750000)) +
    scale_x_date( date_breaks = "2 months",
                  date_labels = "%b'%y",
                  expand = expansion( mult = c(0.1,0.02))) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title =  "Claimant count in London",
         subtitle = paste0("Latest data for period ", new_release_text),
         caption = "\nSource: ONS Claimant Count by sex and age (NSA).\n\nNote: May include some employed claimants on low hours or earnings.")+
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))

  save_GLA_plot(plot_name = "claimant_count")

  ### Claimant count bar charts (edit variable names)
  year_ago_cc <- my(claim_period) - years(1)


```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>

### Year-on-year percentage change

```{r claimant increase, echo = FALSE,fig.cap = claimbarcap, out.width='100%'}
  
  ### Increases in claimants by age
  pal <- gla_pal(gla_theme = "default", palette_type = "highlight", n = c(1, 1))
  theme_set(theme_gla(gla_theme = "default"))
  
  claimant_count_bar <- claimant_count_stats_long %>%
    filter(measure_name=="claimant_count") %>% 
    group_by(sex_name, geography_name, date) %>% 
    mutate(chart_ranking = case_when( age_name == "All categories: Age 16+" ~ 1,
                                      TRUE ~ rank((age_name))+1)) %>% 
    ungroup() %>% 
    filter( sex_name == "Total" & (date == max(date)) & !(age_name %in% c("Aged 16-17", "Aged 18-21", "Aged 18-24", "Aged 50+" , "Age unknown (clerical claims)", "Aged 25-49", "Aged 65+"))) %>% 
    ggplot(mapping = aes(x = reorder(age_name,chart_ranking), 
                         y = change_year_percent, 
                         colour = geography_name , fill=geography_name,
                         text = paste(age_name, "\n",
                                      geography_name, "\n",
                                      "Change in count: ", perc_form(change_year_percent),"%", "\n",
                                      sep = ""))) +
    geom_bar(stat = "identity", position = position_dodge(), width = 0.4) +
    geom_hline(aes(yintercept=0), colour="gray45") +
    scale_colour_manual(values = pal) +
    scale_fill_manual(values = pal) +
    theme_set(theme_gla(gla_theme = "default")) +
    scale_y_continuous(limits = c(-50, 10), labels = dollar_format(prefix = "", 
                                                                   suffix = "%", 
                                                                   largest_with_cents = 1)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 8)) +
    theme(axis.text.x = element_text( hjust=1, vjust=0.5)) +
    theme(plot.margin = unit(c(1,1,1,1), "cm"))+
    labs(title = "Year-on-year percentage change in claimant count",
         subtitle = paste0("Latest data for period ", claim_period),
         caption = "\nSource: ONS Claimant Count by sex and age (NSA).\n\nNote: May include some employed claimants on low hours or earnings.") +
    theme(plot.caption = element_text(color = rgb(166,166,166,maxColorValue = 255)))
  
  save_GLA_plot(plot_name = "claimant_age_increase")
  
  LMU_plotly_settings(ch_name = claimant_count_bar,
                      title_text = 'paste0("Year-on-year percentage change in claimant count")',
                      subtitle_text = 'paste0("Latest data for period ", claim_period)',
                      hover_mode = "closest") 
  
  claimbarcap <- paste0("Source: ONS Claimant Count by sex and age (NSA).","<br>","<br>", "Note: may include some employed claimants on low hours or earnings.")


```

```{r wfj_figures, echo=FALSE}

wfj_newmonth <- wfj_stats %>%  filter(new_date == max(new_date)) %>% filter(row_number()==1) %>% mutate(new_date = format(new_date, '%B %Y'))  %>% select(new_date)

wfj_lastmonth <- wfj_stats %>% filter(new_date == (ymd(max(new_date)) %m+% - months(3))) %>% filter(row_number()==1) %>% mutate(new_date = format(new_date, '%B %Y'))  %>% select(new_date)

wfj_level <- value_form(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% mutate(obs_value=obs_value/1000000) %>% select(obs_value),s=signif_mil, d=digits_mil)


wfj_p_quart_uk <- perc_form(100*(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == max(new_date) & geography_name == "United Kingdom" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd(max(new_date)) %m+% - months(3)) & geography_name == "United Kingdom" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value))/(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd(max(new_date)) %m+% - months(3)) & geography_name == "United Kingdom" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value)),d = digits_perc)


wfj_p_dec19_uk <- perc_form(100*(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == max(new_date) & geography_name == "United Kingdom" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd("2019-12-01")) & geography_name == "United Kingdom" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value))/(wfj_stats %>% filter(item_name == "total workforce jobs" & new_date == (ymd("2019-12-01")) & geography_name == "United Kingdom" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value)),d = digits_perc)

wfj_emp_d_dec19 <- value_form(wfj_stats %>% filter(item_name == "employee jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "employee jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value),s = signif_thous)
  
wfj_emp_p_dec19 <- perc_form(100*(wfj_stats %>% filter(item_name == "employee jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "employee jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value))/(wfj_stats %>% filter(item_name == "employee jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value)),d = digits_perc)

wfj_self_d_dec19 <- value_form(wfj_stats %>% filter(item_name == "self-employment jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "self-employment jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value),s = signif_thous)
  
wfj_self_p_dec19 <- perc_form(100*(wfj_stats %>% filter(item_name == "self-employment jobs" & new_date == max(new_date) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value) - wfj_stats %>% filter(item_name == "self-employment jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value))/(wfj_stats %>% filter(item_name == "self-employment jobs" & new_date == (ymd("2019-12-01")) & geography_name == "London" & measures_name == "Value" & industry_name == "Total") %>% select(obs_value)),d = digits_perc)


```

<hr  width="100%" style="background-color: rgb(134,139,142);height: 1.0px;margin: 0;"/>

<br/>


## Summary of headline indicators

<br/>

```{r flextable indicators, echo = FALSE, ft.align="left", out.width='100%'}
  
  #-------------------------------------------------------------------------------
  #  Create the headline stats table as data frame
  #-------------------------------------------------------------------------------
  
  
  condi_arrow <- function(value) {
    arrow <- case_when( value < 0 ~ "u",
                        value == 0 ~ "v",
                        value > 0 ~ "t")
    return(arrow)
  }
  
  # Create rows to use as subheaders in table
  sub_head_rows <- tibble("geography_name"=c("Employment","Unemployment","Economic Inactivity"),"indicator"=c("emp_","unem_","inact_"),tab_rank=1)
  
  headline_rates <- lfs_stats %>% 
    filter(sex_name == "Total" & geography_name %in% c("London", "United Kingdom") & date == max(date)) %>% 
    mutate(measures_name = case_when(measures == 20100 ~ "num",
                                     measures == 20207 ~ "rate"),
           val_type = case_when(value_type_name == "Level" ~ "le",
                                value_type_name == "Change on quarter" ~ "cq",
                                value_type_name == "Change on year" ~ "cy"),
           geography_name = case_when(geography_name == "United Kingdom" ~ "UK" ,
                                      TRUE ~ "London")) %>% 
    select("date_name", "geography_name","measures_name","val_type","total_in_employment_aged_16_and_over","total_unemployed_aged_16_and_over",
           "total_economically_inactive_aged_16_and_over","total_in_employment_aged_16_to_64","total_economically_inactive_aged_16_to_64") %>% 
    pivot_longer(names_to = "obs_type_help", values_to = "obs_value", cols = "total_in_employment_aged_16_and_over":"total_economically_inactive_aged_16_to_64") %>% 
    mutate(obs_type = case_when(obs_type_help == "total_in_employment_aged_16_and_over" ~ "emp_16_plus",
                                obs_type_help == "total_unemployed_aged_16_and_over" ~ "unem_16_plus",
                                obs_type_help == "total_economically_inactive_aged_16_and_over" ~ "inact_16_plus",
                                obs_type_help == "total_in_employment_aged_16_to_64" ~ "emp_16_64",
                                obs_type_help == "total_economically_inactive_aged_16_to_64" ~ "inact_16_64")) %>%
    filter((measures_name=="num" & obs_type %in% c("emp_16_plus","unem_16_plus","inact_16_64")) | 
             (measures_name=="rate" & obs_type %in% c("emp_16_64","unem_16_plus","inact_16_64"))) %>% #Should make the right combination for table
    mutate(indicator =  str_extract(obs_type,".*?_")) %>% 
    mutate(col_name = paste(measures_name,val_type, sep = "_")) %>% 
    select("date_name","geography_name","obs_value","indicator","col_name") %>% 
    pivot_wider(names_from = "col_name", values_from = "obs_value") %>% 
    mutate(num_cq2 = condi_arrow(num_cq),
           num_cy2 = condi_arrow(num_cy),
           rate_cq2 = condi_arrow(rate_cq),
           rate_cy2 = condi_arrow(rate_cy),
           num_le = round(num_le/1000,0),
           num_cq = round(num_cq/1000,0),
           num_cy = round(num_cy/1000,0),
           tab_rank = case_when(geography_name == "London" ~ 2,
                                geography_name == "UK" ~ 3)) %>% 
    bind_rows(sub_head_rows) %>% 
    arrange(match(indicator,c("emp_","unem_","inact_")), tab_rank) %>% # Row order
    select("date_name","geography_name","indicator","num_le","num_cq","num_cq2","num_cy","num_cy2","rate_le","rate_cq","rate_cq2","rate_cy","rate_cy2") 
  
  #-------------------------------------------------------------------------------
  # Format table appearance manually
  #-------------------------------------------------------------------------------
  
  std_border = fp_border(width = 1)
  no_border = fp_border(width = 0)
  
  headline_rates_table <-  flextable(headline_rates, 
                                     col_keys=c("geography_name","num_le","num_cq","num_cq2","num_cy","num_cy2","rate_le","rate_cq","rate_cq2","rate_cy","rate_cy2")) %>% 
    colformat_num(
      big.mark = ",", decimal.mark = ".", digits=0) %>% 
    font(fontname='Arial', part = "all") %>% 
    # Setting colors and font of change variables to make indicator arrows
    font(j = c("num_cq2", "num_cy2", "rate_cq2", "rate_cy2"), fontname ='Marlett') %>% 
    color( i= ~ indicator %in% "emp_" & num_cq2 %in% "t", j = ~ num_cq2, color = "green") %>%  # Specifically for employment
    color( i= ~ indicator %in% "emp_" & num_cq2 %in% "u", j = ~ num_cq2, color = "red") %>% 
    color( i= ~ indicator %in% "emp_" & num_cy2 %in% "t", j = ~ num_cy2, color = "green") %>% 
    color( i= ~ indicator %in% "emp_" & num_cy2 %in% "u", j = ~ num_cy2, color = "red") %>% 
    color( i= ~ indicator %in% "emp_" & rate_cq2 %in% "t", j = ~ rate_cq2, color = "green") %>% 
    color( i= ~ indicator %in% "emp_" & rate_cq2 %in% "u", j = ~ rate_cq2, color = "red") %>% 
    color( i= ~ indicator %in% "emp_" & rate_cy2 %in% "t", j = ~ rate_cy2, color = "green") %>% 
    color( i= ~ indicator %in% "emp_" & rate_cy2 %in% "u", j = ~ rate_cy2, color = "red") %>%  
    color( i= ~ !(indicator %in% "emp_") & num_cq2 %in% "t", j = ~ num_cq2, color = "red") %>% # For the others
    color( i= ~ !(indicator %in% "emp_") & num_cq2 %in% "u", j = ~ num_cq2, color = "green") %>% 
    color( i= ~ !(indicator %in% "emp_") & num_cy2 %in% "t", j = ~ num_cy2, color = "red") %>% 
    color( i= ~ !(indicator %in% "emp_") & num_cy2 %in% "u", j = ~ num_cy2, color = "green") %>% 
    color( i= ~ !(indicator %in% "emp_") & rate_cq2 %in% "t", j = ~ rate_cq2, color = "red") %>% 
    color( i= ~ !(indicator %in% "emp_") & rate_cq2 %in% "u", j = ~ rate_cq2, color = "green") %>% 
    color( i= ~ !(indicator %in% "emp_") & rate_cy2 %in% "t", j = ~ rate_cy2, color = "red") %>% 
    color( i= ~ !(indicator %in% "emp_") & rate_cy2 %in% "u", j = ~ rate_cy2, color = "green") %>% 
    color( i= ~ num_cq2 %in% "v", j = ~ num_cq2, color = "orange") %>% # If equal
    color( i= ~ num_cy2 %in% "v", j = ~ num_cy2, color = "orange") %>% 
    color( i= ~ rate_cq2 %in% "v", j = ~ rate_cq2, color = "orange") %>% 
    color( i= ~ rate_cy2 %in% "v", j = ~ rate_cy2, color = "orange") %>% 
    #color( i= ~ geography_name %in% "London", j = ~ geography_name, color = rgb(109,167,222, maxColorValue = 255)) %>% 
    #color( i= ~ geography_name %in% "UK", j = ~ geography_name, color = rgb(204,204,204, maxColorValue = 255)) %>% 
    bold(i= ~ geography_name %in% c("Employment","Unemployment","Economic Inactivity"), j = ~ geography_name) %>% 
    add_header_row(colwidths = c(1 ,5, 5),
                   values = c(paste0("Headline estimates for ",headline_rates %>% filter(!is.na(date_name)) %>% filter(row_number()==1)  %>% select(date_name)), "Number* (thousands)","Rate** (%)")) %>% 
    align(part = "header", align = "center") %>% 
    set_header_labels( "geography_name"="","num_le"="Latest Estimate","num_cq"="Change on Quarter","num_cq2"="","num_cy"="Change on Year","num_cy2"="","rate_le"="Latest Estimate","rate_cq"="Change on Quarter","rate_cq2"="","rate_cy"="Change on Year","rate_cy2"="") %>% 
    bold(i=1, part = "header") %>% 
    add_footer_lines("Source: ONS Labour Force Survey. \n \nNotes: All figures are seasonally adjusted. *Numbers are based on total population (16+, male and female), except for inactivity which is 16-64. **Rates are based on working age population (16–64, male and female), except for the unemployment rate which is age 16+.") %>% 
    color( part = "footer", color = rgb(166,166,166,maxColorValue = 255)) %>%
    fontsize(size = 14, part = "all") %>% 
    # Cell widths
    width(j=1, width=6, unit="cm") %>% 
    width(j= ~ num_cq2 + num_cy2 + rate_cq2 + rate_cy2, width=1, unit="cm") %>% 
    # Merging of header cells
    merge_at(i=2,j=3:4,part="header") %>%  
    merge_at(i=2,j=5:6,part="header") %>%  
    merge_at(i=2,j=8:9,part="header") %>%  
    merge_at(i=2,j=10:11,part="header") %>%  
    merge_at(i=1:2,j=1,part="header") %>%  
    # Custom borders
    border_outer(part="header") %>% 
    border_outer(part="body") %>% 
    hline(i=1,part="header", border=no_border) %>% 
    hline(i= ~ geography_name %in% c("Employment","Unemployment","Economic Inactivity") ,part="body", border=std_border) %>% 
    hline(i= ~ geography_name %in% c("UK") ,part="body", border=std_border) %>% 
    vline(border = std_border, part = "all", j = ~ geography_name ) %>% 
    vline(border = std_border, part = "all", j = ~ num_cy2 ) %>% 
    fix_border_issues()
  
  knit_print(headline_rates_table)


```

<a href="#top">Back to top</a>

</font>

::: {.tocify-extend-page data-unique="tocify-extend-page" style="height: 0;"}
:::
